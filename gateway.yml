server:
  port: 8080
  forward-headers-strategy: framework  # important derrière Cloudflare/ngrok (X-Forwarded-* / HTTPS)

spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns:
              - "http://localhost:*"
              - "https://localhost:*"
              - "https://*.trycloudflare.com"
              - "https://*.ngrok-free.app"
              - "https://*.ngrok.app"
            allowedMethods:
              - GET
              - POST
              - PUT
              - PATCH
              - DELETE
              - OPTIONS
            allowedHeaders:
              - "*"
            exposedHeaders:
              - Authorization
              - Location
              - Content-Disposition
            allowCredentials: false
            maxAge: 3600

      routes:
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**,/api/auth,\
              /api/oauth-clients/**,/api/oauth-clients,\
              /api/roles/**,/api/roles,\
              /api/permissions/**,/api/permissions,\
              /api/user-roles/**,/api/user-roles,\
              /api/role-permissions/**,/api/role-permissions,\
              /api/sessions/**,/api/sessions,\
              /api/users/**,/api/users,\
              /api/audit-logs/**,/api/audit-logs,\
              /api/audit/**,/api/audit,\
              /api/users/*/reset-password,\
              /api/vendor-requests/**,/api/vendor-requests,\
              /api/auth/profile/me,\
              /api/auth/profile/me/avatar,\
              /api/auth/impersonate,\
              /uploads/**,/uploads
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCB
                fallback-uri: forward:/fallback/auth

        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/api/products/**,/api/products,\
              /api/categories/**,/api/categories,\
              /api/product-images/**,/api/product-images,\
              /api/product-attributes/**,/api/product-attributes,\
              /api/product-reviews/**,/api/product-reviews

        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**,/api/orders,\
              /api/orders/my/**,/api/orders/my,\
              /api/order-items/**,/api/order-items,\
              /api/order-status/**,/api/order-status,\
              /api/order-payment/**,/api/order-payment,\
              /api/order-payment-status/**,/api/order-payment-status,\
              /api/order-payment-methods/**,/api/order-payment-methods,\
              /api/payments/*/capture,\
              /api/refunds/**,/api/refunds,\
              /api/orders/*/addresses,/api/orders/*/addresses/**,\
              /api/orders/by-number/*/addresses/**,\
              /api/shipments/**,/api/shipments,\
              /api/credit-notes/**,/api/credit-notes,\
              /api/invoices/by-number/*,\
              /api/invoices/by-user/*,\
              /api/invoices/by-date-range/*,\
              /api/invoices/by-status/*,\
              /api/invoices/by-product/*,\
              /api/invoices/by-user-product/*,\
              /api/invoices/*/pdf,\
              /api/invoices/by-number/*/pdf

        - id: cart-service
          uri: lb://cart-service
          predicates:
            - Path=/api/cart/**,/api/cart,\
              /api/carts/**,/api/carts,\
              /api/carts/my

        - id: delivery-service
          uri: lb://delivery-service
          predicates:
            - Path=/api/delivery/**,/api/delivery

        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/notifications/**,/api/notifications

        - id: analytics-service
          uri: lb://analytics-service
          predicates:
            - Path=/api/analytics/**,/api/analytics
            # Si ton Flutter appelle /api/events, décommente ceci :
            # - Path=/api/events/**,/api/events

        - id: ia-web3-service
          uri: lb://ia-web3-service
          predicates:
            - Path=/api/ia/**,/api/ia,\
              /api/recommendations/my,\
              /api/recommendations/feedback,\
              /api/recommendations/rebuild/**,/api/recommendations/rebuild
